# 📱 Take a Break - 真机测试完整指南

## 🎯 为什么要在真机上测试？

- ✅ **真实的 GPS 定位** - 获取你的真实位置，而不是模拟器的固定位置
- ✅ **真实的传感器** - 测试陀螺仪、加速度计等
- ✅ **真实的性能** - 评估实际运行速度
- ✅ **真实的网络** - 测试移动网络环境

---

## 🚀 快速开始（推荐方式）

### 准备工作

1. **确保电脑和手机在同一 WiFi 网络**
2. **获取电脑的局域网 IP 地址**

**在 Mac 上获取 IP：**
```bash
ifconfig | grep "inet " | grep -Fv 127.0.0.1
```

会看到类似：
```
inet 192.168.1.100 netmask 0xffffff00 broadcast 192.168.1.255
```

记住这个 IP：`192.168.1.100`（你的可能不同）

---

### 第 1 步：配置 API 地址

编辑 `apps/mobile/.env.local` 文件（已创建）：

```bash
# 将 YOUR_COMPUTER_IP 替换为你的实际 IP
EXPO_PUBLIC_API_BASE_URL=http://192.168.1.100:3333
```

---

### 第 2 步：启动 API 服务器

**重要：** API 服务器需要监听所有网络接口（0.0.0.0），而不仅仅是 localhost。

```bash
cd /Users/ming/Documents/take-a-break/services/api

# 使用 0.0.0.0 让真机能访问
HOST=0.0.0.0 PORT=3333 pnpm run dev
```

看到这个输出说明成功：
```
API listening on http://0.0.0.0:3333
```

---

### 第 3 步：启动移动应用开发服务器

打开另一个终端：

```bash
cd /Users/ming/Documents/take-a-break/apps/mobile
pnpm run dev
```

会看到一个二维码和开发 URL。

---

### 第 4 步：在手机上打开应用

#### 方式 A：使用 Expo Go（最快）

1. **下载 Expo Go App**
   - iOS: App Store 搜索 "Expo Go"
   - Android: Google Play 搜索 "Expo Go"

2. **扫描二维码**
   - iOS: 用系统相机扫描终端中的二维码
   - Android: 在 Expo Go 中点击 "Scan QR Code"

3. **应用会自动加载并运行**

#### 方式 B：使用 Development Build（更稳定）

如果 Expo Go 不够用，可以构建开发版本：

```bash
# iOS
eas build --profile development --platform ios

# Android
eas build --profile development --platform android
```

构建完成后，在手机上安装该应用。

---

## 🧪 测试清单

### 1. 测试位置服务

- [ ] 打开应用，授予位置权限
- [ ] 查看是否获取到真实的 GPS 坐标
- [ ] 检查控制台日志：

```
[MapService] Device location obtained: {
  lat: 你的真实纬度,
  lng: 你的真实经度,
  accuracy: ...
}
```

### 2. 测试地图功能

- [ ] 选择感觉状态和时间
- [ ] 点击一个方案卡片
- [ ] 点击 "Navigation" 按钮
- [ ] 检查：
  - ✅ 地图加载成功
  - ✅ 显示你的当前位置（蓝点）
  - ✅ 显示附近的真实地点
  - ✅ 可以点击地点查看详情

### 3. 测试导航功能

- [ ] 选择一个地点
- [ ] 点击 "开始导航"
- [ ] 检查：
  - ✅ 显示步行路线
  - ✅ 显示预计时间和距离
  - ✅ 路线合理

### 4. 测试网络功能

- [ ] 关闭 WiFi，使用移动数据
- [ ] 测试应用是否正常工作
- [ ] 检查 API 请求是否成功

---

## 🔧 故障排除

### 问题 1：手机无法连接到开发服务器

**症状：** 扫描二维码后显示 "无法连接到 Metro"

**解决方案：**

1. **确认手机和电脑在同一 WiFi**
   - 不能一个用 WiFi，一个用有线
   - 确保不是访客网络

2. **检查防火墙**
   ```bash
   # Mac 上临时关闭防火墙（测试用）
   # 系统设置 → 安全性与隐私 → 防火墙
   ```

3. **手动输入 URL**
   - 在 Expo Go 中选择 "Enter URL manually"
   - 输入：`exp://192.168.1.100:8081`（替换成你的 IP）

### 问题 2：无法访问 API 服务器

**症状：** 应用加载成功，但显示 "network request failed"

**解决方案：**

1. **确认 API 服务器监听 0.0.0.0**
   ```bash
   # 正确的启动方式
   HOST=0.0.0.0 PORT=3333 pnpm run dev
   
   # 错误：只监听 localhost
   # pnpm run dev
   ```

2. **测试从手机访问 API**
   - 在手机浏览器中打开：`http://192.168.1.100:3333/health`
   - 应该看到 JSON 响应：`{"status":"ok",...}`

3. **检查 .env.local 配置**
   ```bash
   # 确认 IP 地址正确
   cat apps/mobile/.env.local
   ```

4. **重启服务**
   ```bash
   # 终止所有服务（Ctrl+C）
   # 然后重新启动
   ```

### 问题 3：位置权限被拒绝

**症状：** 应用请求位置权限，但被用户拒绝

**解决方案：**

1. **iOS**
   - 设置 → 隐私与安全性 → 定位服务
   - 找到 "Expo Go" 或应用名称
   - 选择 "使用应用期间"

2. **Android**
   - 设置 → 应用 → Expo Go → 权限
   - 启用 "位置"
   - 选择 "仅在使用应用时允许"

### 问题 4：获取到的位置不准确

**解决方案：**

1. **确保在户外或窗边** - GPS 信号需要看到天空
2. **等待几秒** - 初次定位需要时间
3. **检查设置** - 确保开启了"精确位置"（iOS）

---

## 📊 查看调试日志

### 在手机上查看日志

**iOS：**
- 摇晃手机
- 选择 "Show Dev Menu"
- 选择 "Debug Remote JS"

**Android：**
- 摇晃手机或按菜单键
- 选择 "Debug"

### 在电脑上查看日志

日志会显示在运行 `pnpm run dev` 的终端中：

```
[MapService] Resolved API base URL: http://192.168.1.100:3333
[MapService] Getting current location...
[MapService] Device location obtained: {...}
[MapService] Fetching nearby places...
[MapService] Found 15 nearby places
```

---

## 🎨 测试 Google Places API（真实地点）

如果你配置了 Google Maps API：

1. **确认环境变量设置**
   ```bash
   cd /Users/ming/Documents/take-a-break/services/api
   cat .env
   ```

   应该包含：
   ```bash
   GOOGLE_MAPS_API_KEY=你的API密钥
   USE_REAL_MAP_API=true
   ```

2. **重启 API 服务器**
   ```bash
   HOST=0.0.0.0 PORT=3333 pnpm run dev
   ```

3. **在真机上测试**
   - 应该看到你周围的真实地点
   - 咖啡馆、公园、图书馆等

---

## ✅ 成功标志

当一切正常工作时，你应该看到：

1. ✅ **手机显示你的真实位置**
   - 例如：北京、上海、或你所在的城市

2. ✅ **地图显示附近的真实地点**
   - 例如：附近的星巴克、公园、商场

3. ✅ **可以导航到这些地点**
   - 显示实际的步行路线和时间

4. ✅ **控制台日志正常**
   ```
   [MapService] Device location obtained: {lat: 39.9042, lng: 116.4074}
   [MapService] Found 15 nearby places
   ```

---

## 🚀 下一步

测试成功后，你可以：

1. **测试完整的用户流程**
   - 从选择感觉到完成休息
   - 测试所有的交互功能

2. **测试边界情况**
   - 没有网络时的行为
   - GPS 信号弱时的行为
   - 没有附近地点时的行为

3. **收集用户反馈**
   - 邀请朋友测试
   - 记录问题和建议

4. **准备发布**
   - 构建生产版本
   - 提交到 App Store / Google Play

---

## 📞 需要帮助？

如果遇到问题：

1. 检查控制台日志中的详细错误信息
2. 确认网络配置（IP 地址、端口）
3. 验证服务器正在运行并可访问
4. 查看 [NETWORK_FIX_GUIDE.md](./NETWORK_FIX_GUIDE.md) 获取更多故障排除建议

---

## 📱 快速命令参考

```bash
# 获取电脑 IP
ifconfig | grep "inet " | grep -Fv 127.0.0.1

# 启动 API 服务器（真机访问）
cd services/api
HOST=0.0.0.0 PORT=3333 pnpm run dev

# 启动移动应用
cd apps/mobile
pnpm run dev

# 测试 API（从手机浏览器）
http://你的电脑IP:3333/health

# 构建开发版本
eas build --profile development --platform ios
eas build --profile development --platform android
```

祝测试顺利！🎉



